<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://www.samanthacarbontherapy.co.uk/wp-content/uploads/2020/05/Leaf-Icon.png">
    <title>GauGAN</title>

    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/atrament.js/1.0.0/atrament.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>
    <script async src="opencv.js" onload="openCvReady"></script>
    <script src="painter.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
        }
        * {
            box-sizing: border-box;
        }
        #root {
            flex: 1;
            display: flex;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <style>
        #nav{
            display: flex;
            flex-direction: column;
            width: 100%;
        }
       

        
        .container {
            display: flex;
            flex: 1;
            justify-content: center;
            align-items: center;
            
            background: #111111;
            color: #cccccc;
            font-family: 'Roboto', sans-serif;
        }
        #virtual_painter_Canvas{
            display: none;
            flex-direction: row-reverse;
            justify-content: center;
            align-items: center;
        }
        #sketchpad, #rendered ,#canvas_output2,#canvas_output3,#canvas_output1{
            width: 512px;
            height: 512px;
            background: #262626;
            margin: 5px;
        }

        #rendered {
            display: flex;
            position: relative;
            /* background: url(https://upload.wikimedia.org/wikipedia/commons/3/35/Neckertal_20150527-6384.jpg); */
        }
        .no-render {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            /* display:none; */
        }
        .no-render .icon {
            font-size: 80px;
            color: #adadad;
        }
        .no-render>.label {
            font-size: 12px;
            margin-top: 8px;
            color: #adadad;
            width: 190px;
            text-align: center;
            margin-bottom: 20px;
        }
        .generated-image {
            flex-grow: 1;
        }
        .btn-render {
            position: absolute;
            background: rgba(15, 48, 214, 0.5);
            color: #e8e8e8;
            width: 160px;
            border-radius: 3px;
            text-align: center;
            padding: 10px;
            bottom: 40px;
            left: 50%;
            margin-left: -80px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-render:hover {
            background: rgba(15, 48, 214, 0.7);
            padding: 11px;
            bottom: 39px;
            width: 162px;
            margin-left: -81px;
        }

        #toolbar {
            background: #303030;
            width: 220px;
            height: 512px;
            margin: 5px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
        }
        #toolbar .row {
            margin-bottom: 5px;
        }
        #toolbar .label {
            padding: 3px 3px 8px;
        }
        #toolbar .field {
            padding: 3px;
        }
        #toolbar .color-panel {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #toolbar .scroll {
            overflow: scroll;
            background: rgba(0,0,0,.3);
            padding: 4px;
            flex-grow: 1;
        }
        #toolbar .color {
            padding: 5px;
            margin: 5px;
            color: white;
        }

        input,#virtual ,#Exit_Button,#config_btn,#ex_config{
            width: 98%;
        }
        #Exit_Button,#config_btn,#ex_config{
            display: none;
        }
        p{
            margin-bottom: 0px;
        }
        /* #Exit_Button2{
            background: none;
            color: inherit;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            outline: inherit;
        } */
        /* #hold,#toggle{
            width: 20%;
        } */
        input[type="button"] ,#virtual,#Exit_Button,#config_btn,#ex_config{
            padding: 7px;
            background: #676767;
            color: white;
            border: 0;
            border-radius: 3px;
            font-size: 13px;
            margin: 5px 0;
            cursor: pointer;
        }
          .color:hover {
                border: #ffffff 3px solid;
            }

        .color:active {
            border: #AFF20A 4px solid;
        }
        #Modes{
            display: none;
            flex-direction: column;
        }
        #mode{
            display: flex;
            flex-direction: row; 
        }
        #mode>label{
            margin-left: -0.5rem; 
        }

        #navbar{
    top:0px;
    display: none;
    flex-direction: row;
}
#color1,
#color2,
#color3,
#color4 {
  display: inline-block;
  background-color: white;
  height: 80px;
}

#color1 {
  border-bottom: 12px solid #D4838F;
  width: 16.67%;
}

#color2 {
  border-bottom: 12px solid #2B879E;
  width: 16.67%;
}


#color3 {
  border-bottom: 12px solid #3EC9A7;
  width: 16.67%;
}




#color4 {
  border-bottom: 12px solid #F2E8C4;
  width: 16.67%;
}

#color5{
    border-bottom: 12px solid #3EC9A7;
  width: 16.67%;
}

#color6{
    border-bottom: 12px solid #D4838F;
  width:16.67%;
}
.radios{
    display: flex;
    flex-direction: column;
}
.radios label{
    padding-right: 15px;
   margin: auto;
   width: 50%;
}

    </style>
    <script type="text/babel">
        // this.sketchpad.color = 'none';
        const colorMap = [
            { color: "#384f83", id: 154, label: "sea" },
            { color: "#efefef", id: 105, label: "cloud", labelColor: "black" },
            { color: "#2c1e16", id: 110, label: "dirt" },
            { color: "#5d6e32", id: 96, label: "bush" },
            { color: "#b7d24e", id: 123, label: "grass", labelColor: "black" },
            { color: "#3c3b4b", id: 134, label: "mountain" },
            { color: "#987e6a", id: 148, label: "road" },
            { color: "#759edf", id: 156, label: "sky" },
            { color: "#352613", id: 168, label: "tree" },
            { color: "#e670b6", id: 118, label: "flower" },
            { color: "#c1c3c9", id: 119, label: "fog", labelColor: "black" },
            { color: "#776c2d", id: 126, label: "hill" },
            { color: "#bf602c", id: 128, label: "leaves" },
            { color: "#32604d", id: 147, label: "river" },
            { color: "#fafafa", id: 158, label: "snow", labelColor: "black" },
        ];
        const colorwh = [
            { color: "#ffffff", id: 147, label: "white" },
        ];
        const hexToColorMap = colorMap.reduce((combined, color) => {
            combined[color.color] = color;
            return combined;
        }, {});
        function componentToHex(c) {
            const hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }
        function rgbToHex(r, g, b) {
            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
        }

        class SketchBoard extends React.Component {
            constructor(props) {
                super(props);
                this.canvasRef = React.createRef();
                this.state = {
                    image: null,
                    strokeWidth: 18,
                    url: this.canvasRef,
                    draw_color : 'None'
                };
            }

            componentDidMount() {
                this.sketchpad = new Atrament(this.canvasRef.current, {
                    width: 512,
                    height: 512,
                });
                this.clearSketch();
                // change the line thickness in pixels
                this.sketchpad.weight = this.state.strokeWidth;
                // tweak smoothing - higher values make the drawings look much better, 
                // lower values make drawing feel a bit more responsive. Set to 0.85 by default.
                this.sketchpad.smoothing = .45;
                this.sketchpad.adaptiveStroke = false;
            }

            clearSketch = () => {
                this.sketchpad.clear();
                this.setSketchColor(colorwh.find(c => c.label == "white").color);
                this.sketchpad.fill();
                // fill uses setTimeout of 100, so we need a bigger timeout...
                setTimeout(() => {
                    this.setSketchColor(colorMap.find(c => c.label == "grass").color);
                }, 250);
            }

            setSketchColor = (color) => {
                this.sketchpad.color = color;
                this.setState({
                    draw_color: color,
                });
            }

            setSketchStrokeWidth = (width) => {
                this.sketchpad.weight = this.state.strokeWidth;
                this.setState({
                    strokeWidth: width,
                });
            }
            
            downloadCanvas = (filename) => {
                this.href = this.canvasRef.current.toDataURL();
                console.log("url: ", this.href);
                this.download = filename;
                this.setState({
                    url: this.href
                })
            }

            generateSketch = async () => {
                const context = this.sketchpad.context;
                const colorLayer = context.getImageData(0, 0, context.canvas.width, context.canvas.height).data;
                
                const colors = [];
                const sketch = [];
                let match_id = 255;
                for (let y = 0; y < context.canvas.height; y++) {
                    sketch[y] = [];
                    for (let x = 0; x < context.canvas.width; x++) {
                        const pixelPos = (y * context.canvas.width + x) * 4;
                        const pixelR = colorLayer[pixelPos];
                        const pixelG = colorLayer[pixelPos + 1];
                        const pixelB = colorLayer[pixelPos + 2];
                        
                        const color_match = hexToColorMap[rgbToHex(pixelR, pixelG, pixelB)];
                        if (color_match) {
                            match_id = color_match.id;
                        }
                        sketch[y][x] = match_id;
                    }
                }
                
                 console.log(sketch)

                
                
            }
           
            render() {
                return <React.Fragment>
                    <div id="nav">
                        <div id="navbar">
                        <div id="color1" className="col-xs-3">
                            <div className="label">Lower Hue : {this.state.strokeWidth}px</div>
                            <input type="range" id="lower_hue" defaultValue ="57" min="0" max ="180"/>
                        </div>
                        <div id="color2" className="col-xs-3">
                            <div className="label">Lower Sat : {this.state.strokeWidth}px</div>
                            <input type="range" id="lower_sat" defaultValue ="67" min="0" max ="255"/>
                        </div>
                        <div id="color3" className="col-xs-3">
                            <div className="label">Lower Val : {this.state.strokeWidth}px</div>
                            <input type="range" id="lower_val" defaultValue ="0" min="0" max ="255"/>
                        </div>
                        <div id="color4" className="col-xs-3">
                            <div className="label">Upper Hue : {this.state.strokeWidth}px</div>
                            <input type="range" id="upper_hue" defaultValue ="100" min="0" max ="180"/>
                        </div>
                        <div id="color5" className="col-xs-3">
                            <div className="label">Upper Sat : {this.state.strokeWidth}px</div>
                            <input type="range" id="upper_sat" defaultValue ="255" min="0" max ="255"/>
                        </div>
                        <div id="color6" className="col-xs-3">
                            <div className="label">Upper Val : {this.state.strokeWidth}px</div>
                            <input type="range" id="upper_val" defaultValue ="255" min="0" max ="255"/>
                            
                        </div>
                        
                    </div>

                    <div className="container">
                        <div id="toolbar">
                            <div className="row">
                                <input id="clear_btn" type="button" value="Clear" onClick={() => this.clearSketch()} />
                                {console.log(this.state.url)}
                                <a id="save_btn" href={this.state.url} download><input type="button" value="Save" onClick={() => this.downloadCanvas(this, 'Drawing.png')} /></a>
                                {/* button Event for Virtual painter*/}
                                <button id="virtual" onClick={openCvReady}>Virtual Painter</button>
                                  {/* Exit Button for virtual Painter*/}
                                <button id="Exit_Button" className="btn" onClick={exit_now}>
                                    Exit Virtual
                                    </button>
                                    <button id="config_btn" className="btn" onClick={config}>
                                    Config
                                    </button>
                                    <button id="ex_config" className="btn" onClick={exit_config}>
                                    Exit Config
                                    </button>

                                {/* Modes of Drawing in Virtual painter*/}
                                <div id="Modes">
                                    <p>Select your work mode:</p>
                                    <div id="mode">
                                        <div className="radios">
                                        <input type="radio" name="mode" value="toggle" id="toggle"/>
                                        <label>toggle</label>
                                        </div>
                                        <div className="radios">
                                        <input type="radio" name="mode" value="hold" id="hold"/>
                                        <label>hold</label>
                                        </div>
                                        <div className="radios">
                                        <input type="radio" name="mode" value="line-toggle" id="line-toggle"/>
                                        <label>line</label>
                                        </div>
                                        <div className="radios">
                                        <input type="radio" name="mode" value="circle-toggle" id="circle-toggle"/>
                                        <label>circle</label>
                                        </div>
                                        </div>
                                </div>
                               
                            </div>
                            <div  id="stroke" className="row">
                                <div id = "stroke_value" className="label">Stroke Thickness: {this.state.strokeWidth}px</div>
                                <div className="field">
                                    <input type="range" min="1" max="80" id="stroke_width"
                                        value={this.state.strokeWidth}
                                        onChange={(e) => {
                                            this.setSketchStrokeWidth(parseInt(e.target.value));
                                        }} />
                                </div>
                            </div>
                            <div className="row color-panel">
                                <div className="label">Color Palette: {this.state.draw_color}</div>
                                <div className="scroll">
                                    {colorMap.map(c => 
                                        <div key={c.color} id={c.color==this.state.draw_color ? "colorValue" : ""} className="color" style={{
                                            'background': c.color,
                                            'color': c.labelColor || 'white',
                                            'textShadow': c.labelColor ? '' : '0 0 1px black' 
                                        }} onClick={() => this.setSketchColor(c.color)}>{c.label}</div>
                                    )
                                }
                                </div>
                            </div>
                        </div>
                        
                        
                        {/*Virtual Painter output Canvas*/}
                        <div id="virtual_painter_Canvas">
                            <video id="cam_input" height="512" width="512" ></video>
                            <canvas id="canvas_output1" className="s"></canvas>
                            <canvas id="canvas_output2" className="s"></canvas>
                            <canvas id="canvas_output3" className="s"></canvas>
                        </div>
                        {/*sketchpad*/}
                        <canvas id="sketchpad" className="s" ref={this.canvasRef}></canvas>
                        <div id="rendered" className="r">
                            {this.state.image ? null : <div className="no-render">
                                <div className="icon"><i className="far fa-images"></i></div>
                                <div className="label">Paint something then click the render button below!</div>
                            </div>}
                            {this.state.image ? <img className="generated-image" src={this.state.image} /> : null}
                            <div className="btn-render" onClick={this.generateSketch}>Generate Image</div>
                        </div>
                    </div>
                   </div>
                    
                </React.Fragment>;
            }
        }
        

        ReactDOM.render(
            <SketchBoard />,
            document.getElementById('root')
        );
    </script>
</body>

</html>