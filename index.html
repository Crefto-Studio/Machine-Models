<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opencv JS</title>
    <script async src="js/opencv.js" onload="openCvReady();"></script>
    <!-- <script src="js/utils.js"></script> -->
</head>
<div>
    <input type="range" id="lower_hue" value ="20" min="0" max ="180">
    <input type="range" id="lower_sat" value ="160" min="0" max ="255">
    <input type="range" id="lower_val" value ="60" min="0" max ="255">
    <input type="range" id="upper_hue" value ="180" min="0" max ="180">
    <input type="range" id="upper_sat" value ="255" min="0" max ="255">
    <input type="range" id="upper_val" value ="255" min="0" max ="255">
</div>

<body>
    <video id="cam_input" height="480" width="640"></video>
    <canvas id="canvas_output"></canvas>
    <canvas id="canvas_output2"></canvas>
    <canvas id="canvas_output3"></canvas>
</body>
<script type="text/JavaScript">
function openCvReady() {
  cv['onRuntimeInitialized']=()=>{
    let Draw_event = false;
    let flag = 0;

    //event handler for pressing on space
    window.addEventListener("keydown", function(event) {
    if (event.defaultPrevented) {
      return;
    }
    if (event.code === "Space"){
        // Handle "Space"
        Draw_event = true;
        console.log('Space');
    }
    event.preventDefault();
  }, true);
  
  //event handler for releasing space
  window.addEventListener("keyup", function(event) {
    if (event.defaultPrevented) {
      return;
    }
    if (event.code === "Space"){
        // Handle "Space"
        Draw_event = false;
        flag=0;
        console.log('Space false');
    }
    event.preventDefault();
  }, true);

    let video = document.getElementById("cam_input"); // video is the id of video tag
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
    .then(function(stream) {
        video.srcObject = stream;
        video.play();
    })
    .catch(function(err) {
        console.log("An error occurred! " + err);
    });

//------------------------------------------------------------------ Initialization
     let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
     let hsv = new cv.Mat(video.height, video.width, cv.CV_8UC1);
     let mask = new cv.Mat(video.height, video.width, cv.CV_8UC1);
     let paint_window = new cv.Mat(video.height, video.width, cv.CV_8UC1, [255,255,255,255]);
     let points = [];
     let connect = [];
     //let kernel = new cv.Mat.ones(5,5,cv.CV_8UC1);

     let cap = new cv.VideoCapture(cam_input);

//------------------------------------------------------------------- Processing
    const FPS = 24;
    function processVideo() {
        let begin = Date.now();
        cap.read(src);
        //src.copyTo(hsv);

            let lower_hue = document.getElementById('lower_hue').value;
            let upper_hue = document.getElementById('upper_hue').value;
            let lower_sat = document.getElementById('lower_sat').value;
            let upper_sat = document.getElementById('upper_sat').value;
            let lower_val = document.getElementById('lower_val').value;
            let upper_val = document.getElementById('upper_val').value;

        let lower_hsv_a = [lower_hue, lower_sat, lower_val];
        let upper_hsv_a = [upper_hue, upper_sat, upper_val];

        // console.log('lower : ',lower_hsv_a);
        // console.log('upper : ',upper_hsv_a);

     let lower_hsv = cv.matFromArray(1, 3, cv.CV_8UC1, lower_hsv_a);
     let upper_hsv = cv.matFromArray(1, 3, cv.CV_8UC1, upper_hsv_a);

     let rect1  = new cv.Point(40, 1);
     let rect2  = new cv.Point(140, 65);
     let rect3  = new cv.Point(49,33);
     let clear = cv.rectangle(src, rect1, rect2, [0,0,0,0],1 );
     cv.putText(src, 'Clear all', rect3, cv.FONT_HERSHEY_SIMPLEX, 0.5, [0,0,0,0],2); //(input , text , position , font , font scale , color , thickness)
 
     let k = Array(5);
     for (var i = 0; i < 5; i++) {
        k[i] = Array(5).fill(1);
     }

     //---------------------------------------------------------- creating kernel for morphological operations 
        let kernel = cv.matFromArray(5, 5, cv.CV_8UC1, k);
        cv.cvtColor(src,hsv, cv.COLOR_BGR2HSV);
        cv.inRange(hsv ,lower_hsv, upper_hsv , mask);
        // cv.erode(mask ,mask , kernel);
        // cv.morphologyEx(mask,mask , cv.MORPH_OPEN, kernel);
        // cv.dilate(mask,mask , kernel);

    //----------------------------------------------------------- Find Contours
        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        cv.findContours(mask, contours, hierarchy, cv.RETR_CCOMP, cv.CHAIN_APPROX_SIMPLE);
        //let center = Null;
        let center =[0,0];
        if(contours.size() > 0)
        {
            // getting the contour of max area
                let area = 0;
                let max= 0;
                let cnt = 0;
            for(var i=0;i<contours.size();i++)
            {
                cnt = contours.get(i);
                area = cv.contourArea(cnt, false);
                if(area >max)
                {
                    max = area;
                }
            }

            let M = cv.moments(cnt, false);
            center = [M.m10/M.m00,M.m01/M.m00];

            if ( (center[1] <= 65) && (40<= center[0] <= 140))
            {
                points = [];
                connect = [];
                paint_window.delete();
                paint_window = new cv.Mat(video.height, video.width, cv.CV_8UC1, [255,255,255,255]);
            }
            // if the points and event on exist then push else don't
            else if(center[0] && (Draw_event == true))
            {
                points.push(center);
                //check connectivity
                if(flag ==0)
                {
                    connect.push(false); //it means it just came from a break (don't connect this point to the last one)
                    flag = 1;
                }
                else
                    connect.push(true); //it means it is connected to the last point

            }
        }

    //----------------------------------------------------------- Drawing Line
        for(var i=1;i<points.length;i++)
        {
                //  console.log(center);
                if(connect[i])
                {
                    let p1  = new cv.Point(points[i][0], points[i][1]);
                    let p2  = new cv.Point(points[i-1][0], points[i-1][1]);
                    cv.line(src, p1, p2, [0, 255, 0, 255],5); // Last parameter is the thickness
                    cv.line(paint_window, p1, p2, [0, 255, 0, 255],5); // Last parameter is the thickness
                }
                else
                    console.log(connect);
        }



        cv.imshow("canvas_output", mask);
        cv.imshow("canvas_output2", src);
        cv.imshow("canvas_output3", paint_window);
        // schedule next one.
        let delay = 1000/FPS - (Date.now() - begin);
        setTimeout(processVideo, delay);
}
// schedule first one.
setTimeout(processVideo, 0);
  };
}
</script>
</html>